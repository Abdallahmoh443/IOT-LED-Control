<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT LED Control Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">

</head>
<body>

    <div class="container">
        <h1> IoT LED Control Dashboard</h1>
        
        <div class="led-grid">
            <!-- LED 1 -->
            <div class="led-control">
                <div class="led-header">
                    <h2 class="led-title">LED 1</h2>
                    <div class="led-icon">
                        <div class="led-bulb" id="led1-icon"></div>
                    </div>
                </div>
                
                <div class="switch-container">
                    <span class="switch-label">Power</span>
                    <label class="switch">
                        <input type="checkbox" id="led1-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="intensity-container">
                    <div class="intensity-label">
                        <span>Intensity</span>
                        <span class="intensity-value" id="led1-value">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" class="intensity-slider" id="led1-slider">
                </div>
            </div>

            <!-- LED 2 -->
            <div class="led-control">
                <div class="led-header">
                    <h2 class="led-title">LED 2</h2>
                    <div class="led-icon">
                        <div class="led-bulb" id="led2-icon"></div>
                    </div>
                </div>
                
                <div class="switch-container">
                    <span class="switch-label">Power</span>
                    <label class="switch">
                        <input type="checkbox" id="led2-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="intensity-container">
                    <div class="intensity-label">
                        <span>Intensity</span>
                        <span class="intensity-value" id="led2-value">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" class="intensity-slider" id="led2-slider">
                </div>
            </div>

            <!-- LED 3 -->
            <div class="led-control">
                <div class="led-header">
                    <h2 class="led-title">LED 3</h2>
                    <div class="led-icon">
                        <div class="led-bulb" id="led3-icon"></div>
                    </div>
                </div>
                
                <div class="switch-container">
                    <span class="switch-label">Power</span>
                    <label class="switch">
                        <input type="checkbox" id="led3-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="intensity-container">
                    <div class="intensity-label">
                        <span>Intensity</span>
                        <span class="intensity-value" id="led3-value">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" class="intensity-slider" id="led3-slider">
                </div>
            </div>
        </div>

        <div class="status disconnected" id="status">
            Disconnected from ESP32
        </div>
    </div>

    <script>
        // LED control logic
        const leds = [1, 2, 3];
        
        // Handle Web Socket
        var HOST = "ws://localhost:3000";
        var ws = new WebSocket(HOST);

        // Update connection status
        ws.onopen = () => {
            document.getElementById('status').textContent = "Connected to WebSocket Server";
            document.getElementById('status').className = "status connected";
        };

        ws.onclose = () => {
            document.getElementById('status').textContent = "Disconnected from WebSocket Server";
            document.getElementById('status').className = "status disconnected";
        };

        // Update LED icon color based on intensity
        function updateLEDIcon(iconEl, isOn, intensity) {
            if (!isOn) {
                iconEl.style.background = 'radial-gradient(circle at 30% 30%, #555, #222)';
                iconEl.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
                iconEl.classList.remove('on');
            } else {
                const brightness = intensity / 255;
                const r = Math.floor(255 * brightness);
                const g = Math.floor(200 * brightness);
                const b = Math.floor(50 * brightness);
                
                iconEl.style.background = `radial-gradient(circle at 30% 30%, rgb(${r}, ${g}, ${b}), rgb(${r*0.6}, ${g*0.6}, ${b*0.6}))`;
                iconEl.style.boxShadow = `0 0 ${20 + brightness * 20}px rgba(${r}, ${g}, ${b}, ${brightness})`;
                iconEl.classList.add('on');
            }
        }

        leds.forEach(num => {
            const switchEl = document.getElementById(`led${num}-switch`);
            const sliderEl = document.getElementById(`led${num}-slider`);
            const valueEl = document.getElementById(`led${num}-value`);
            const iconEl = document.getElementById(`led${num}-icon`);

            // Event listeners only send messages to the server (they don't affect the state)
            // Switch event listener
            switchEl.addEventListener('change', (e) => {
                const isOn = e.target.checked;
                const intensity = parseInt(sliderEl.value);
                
                // Send WebSocket message
                ws.send(JSON.stringify({
                    id: num,
                    status: isOn,
                    intensity: isOn ? intensity : 0
                }));
            });

            // Slider event listener
            sliderEl.addEventListener('input', (e) => {
                const intensity = parseInt(e.target.value);
                valueEl.textContent = intensity;
                
                // Send WebSocket message only if LED is on
                if (switchEl.checked) {
                    ws.send(JSON.stringify({
                        id: num,
                        status: true,
                        intensity: intensity
                    }));
                }
                
                // Update icon locally
                updateLEDIcon(iconEl, switchEl.checked, intensity);
            });

            // Initialize
            sliderEl.disabled = true;
            updateLEDIcon(iconEl, false, 0);
        });

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            console.log("Received Message: ", msg);
            
            // Handle connection status message
            if (msg.type === "connection_status") {
                if (msg.esp32Connected) {
                    document.getElementById('status').textContent = "Connected to ESP32";
                    document.getElementById('status').className = "status connected";
                } else {
                    document.getElementById('status').textContent = "Disconnected from ESP32";
                    document.getElementById('status').className = "status disconnected";
                }
                return;
            }
            
            // Handle initialization message
            if (msg.type === "init" && msg.leds) {
                msg.leds.forEach((led, index) => {
                    const switchEl = document.getElementById(`led${index+1}-switch`);
                    const sliderEl = document.getElementById(`led${index+1}-slider`);
                    const valueEl = document.getElementById(`led${index+1}-value`);
                    const iconEl = document.getElementById(`led${index+1}-icon`);
                    
                    switchEl.checked = led.status;
                    sliderEl.disabled = !led.status;
                    sliderEl.value = led.intensity;
                    valueEl.textContent = parseInt(led.intensity);
                    updateLEDIcon(iconEl, led.status, led.intensity);
                });
                return;
            }
            
            // Handle individual LED update
            if (msg.id && msg.id >= 1 && msg.id <= 3) {
                const switchEl = document.getElementById(`led${msg.id}-switch`);
                const sliderEl = document.getElementById(`led${msg.id}-slider`);
                const valueEl = document.getElementById(`led${msg.id}-value`);
                const iconEl = document.getElementById(`led${msg.id}-icon`);
                
                switchEl.checked = msg.status;
                sliderEl.disabled = !msg.status;
                sliderEl.value = msg.intensity;
                valueEl.textContent = parseInt(msg.intensity);
                updateLEDIcon(iconEl, msg.status, msg.intensity);
            }
        };
       
    </script>
</body>
</html>
